version: "3"

services:
  master:
    image: brume-master
    build:
      context: ./brume
      dockerfile: Dockerfile.dev
    volumes:
      - ./brume:/brume
    ports:
      - 9877:9877
    depends_on:
      - postgres
    networks:
      brume-net:
        aliases:
          - brume

  console:
    image: brume-console
    build:
      context: ./console
      dockerfile: Dockerfile.dev
    ports:
      - 3000:5173
    volumes:
      - ./console/src:/app/src

  postgres:
    image: postgres:13
    environment:
      POSTGRES_USER: brume
      POSTGRES_PASSWORD: brumepass
      POSTGRES_DB: brume
      PGDATA: /data/postgres
    volumes:
      - postgres:/data/postgres
    networks:
      brume-net:
        aliases:
          - postgres

  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@brume.dev
      PGADMIN_DEFAULT_PASSWORD: pass
    # PGADMIN_CONFIG_SERVER_MODE: "False"
    # PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    # PGADMIN_LISTEN_ADDRESS: 0.0.0.0
    # PGPASSFILE: /pgpass
    # PG_DIR: /var/lib/pgadmin
    ports:
      - 9001:80
    volumes:
      - ./infra/pgadmin-servers.json:/pgadmin4/servers.json
    networks:
      brume-net:
        aliases:
          - pgadmin
  dozzle:
    image: amir20/dozzle:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 9000:8080

  temporal:
    depends_on:
      - postgres
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=brume
      - POSTGRES_PWD=brumepass
      - POSTGRES_SEEDS=postgres
      - DYNAMIC_CONFIG_FILE_PATH=/etc/temporal/config/dynamicconfig/temporal.yaml
    image: temporalio/auto-setup:${TEMPORAL_VERSION}
    networks:
      - brume-net
    ports:
      - 7233:7233
    volumes:
      - ./infra/temporal.yaml:/etc/temporal/config/dynamicconfig/temporal.yaml

  temporal-admin-tools:
    depends_on:
      - temporal
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CLI_ADDRESS=temporal:7233
    image: temporalio/admin-tools:${TEMPORAL_ADMINTOOLS_VERSION}
    networks:
      - brume-net
    stdin_open: true
    tty: true

  temporal-ui:
    depends_on:
      - temporal
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000
    image: temporalio/ui:${TEMPORAL_UI_VERSION}
    networks:
      - brume-net
    ports:
      - 8080:8080

  # clickhouse:
  #   image: "clickhouse/clickhouse-server"
  #   user: "101:101"
  #   ports:
  #     - "127.0.0.1:8123:8123"
  #     - "127.0.0.1:9000:9000"
  #   volumes:
  #     - "./clickhouse/config.xml:/etc/clickhouse-server/config.d/config.xml"
  #     - "./clickhouse/users.xml:/etc/clickhouse-server/users.d/users.xml"
  #   depends_on:
  #     - clickhouse-keeper

  # clickhouse-keeper:
  #   image: "clickhouse/clickhouse-keeper"
  #   user: "101:101"
  #   volumes:
  #     - "./clickhouse/keeper.xml:/etc/clickhouse-keeper/keeper_config.xml"
  #   ports:
  #     - "127.0.0.1:9181:9181"

networks:
  brume-net:
    driver: bridge

volumes:
  postgres:
